# OFD文件损坏问题修复测试

## 问题描述
用户报告在打开某些OFD文件时出现错误：
```
打开文档失败:解压OFD文件失败:End of Central Directory record could not be found.
```

## 修复内容

### 1. 主窗体文件验证 (MainForm.cs)
- 添加了 `ValidateOfdFile` 方法，在打开查看器前预先验证文件
- 检查文件大小、ZIP文件头、OFD.xml根文件、Doc目录结构
- 提供更详细的错误信息和建议

### 2. 查看器错误处理 (OfdViewerForm.cs)
- 改进了 `OpenOfdDocument` 方法的异常处理
- 添加了 `PreValidateOfdFile` 方法进行预验证
- 针对不同类型的错误提供具体的解决建议

## 测试方法

### 1. 测试损坏的OFD文件
创建一个损坏的文件来测试错误处理：
```bash
# 创建一个假的OFD文件（不是有效的ZIP格式）
echo "这不是一个有效的OFD文件" > test_corrupted.ofd
```

### 2. 测试空文件
```bash
# 创建空文件
touch test_empty.ofd
```

### 3. 测试有效的ZIP但不是OFD格式
创建一个普通的ZIP文件并重命名为.ofd

## 预期行为

### 文件验证阶段
- 空文件 → "文件为空"
- 非ZIP格式 → "文件不是有效的ZIP格式"
- 缺少OFD.xml → "文件中缺少OFD.xml根文件"
- 缺少Doc目录 → "文件中缺少Doc目录，OFD文档结构不完整"

### OFD读取阶段
- ZIP结构损坏 → 提供详细的修复建议
- 权限问题 → "没有访问文件的权限"
- 文件被占用 → "无法访问文件"

## 用户友好的错误信息
现在当文件损坏时，用户会看到：
```
OFD文件的ZIP压缩包结构损坏。
可能的原因：
1. 文件在下载或传输过程中损坏
2. 文件被病毒软件修改
3. 磁盘存储错误
4. 文件正在被其他程序使用

建议：
- 重新下载或获取文件
- 检查文件是否被其他程序占用
- 尝试从备份恢复文件
```

## 技术实现

### 文件验证流程
1. 检查文件存在性和大小
2. 验证ZIP文件头 (0x504B)
3. 尝试作为ZIP档案打开
4. 检查OFD必需的文件结构
5. 如果验证失败，询问用户是否强制尝试

### 异常处理改进
- 捕获特定的ZIP相关异常
- 提供针对性的错误消息
- 包含用户可操作的建议